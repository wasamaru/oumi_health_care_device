# 量産版アップグレード計画_整理（メカ・ファーム・回路／流用・改修ブロック）

> ※本ドキュメントは、提供資料のうち **minutes_1** を「アップデート要求の唯一の根拠」とし、その他の添付（既存回路の解析・部品表・回路ブロック解説）は「既存実装の事実確認」のみに用いて整理しています。将来提案・推測は含みません。

---

## 1. 既存で実装されている内容（整理）

### 1.1 メカ（筐体・装着）

* 腰装着型（ベルトのポケットに収納）。
* モバイルバッテリー外付け方式。

出典：minutes_1「現行仕様／既存機能」。

### 1.2 ファーム（機能）

* 足の踏み込みタイミングに合わせた腰部振動。
* 固定リズムの振動（4モード切替）。
* Bluetooth によるスマートフォン連携。

出典：minutes_1「現行仕様／既存機能」。

### 1.3 回路（主要ブロックと採用部品）

* 電源変換：TPS630250（昇降圧 DC/DC）。
* 電源管理：LTC2955（プッシュボタン電源制御）。
* ロードスイッチ：TPS22919。
* 無線／MCU：太陽誘電 EYSHCNZXZ（BLE モジュール）。
* 出力：4 チャンネル独立 MOSFET 駆動（FDV305N×4）、出力コネクタ PJ1‑023、保護ダイオード 1N4148WX‑TP。
* UI：DIP スイッチ、デバッグ端子、LED、リセット（S3）。
* 入力コネクタ：microUSB（CN1: 10118194‑0001LF）。

出典：既存の回路解析・回路ブロック解説・部品表。

---

## 2. 今回アップデートしたい内容（minutes_1 の記載に限定）

### 2.1 インターフェース／UI

* USB 端子：**Type‑C 対応に変更**。
* 操作ボタン追加：**モード選択（4モード）／ボリューム調整／ピッチ調整（5段階）**。
* 誤操作防止：**同時押し機能**を実装。
* 状態表示：**LED でモード表示**。

### 2.2 出力構成

* モーター出力 4 個のうち **2 個をスピーカー出力に変更可能**。
* 対応構成：

  * モーター4個
  * モーター2個＋スピーカー2個
* **同一ポートでモーター／スピーカー自動認識**（ポート共用化）。

補足（デバイス選定・方式）

* モーター：シリンダー型振動モーター「SD-0820CY」。
* スピーカー：受動スピーカー＋5V単電源BTL Class‑Dアンプ構成（MOSFETはアンプのEN/SD制御に使用）。

### 2.3 メカ（筐体デザイン）

* 現状課題：ゴツい／イカつい印象。
* 改善要望：**薄型化／丸み付与／スリム化／装着快適性向上**。

### 2.4 その他仕様

* 通信：Bluetooth（スマホ／靴センサーと通信）。
* 認証：**Bluetooth SIG 認証**が必要。
* 電源：モバイルバッテリー外付け、接続は **USB Type-C**、**内蔵バッテリー不要**。
* メモリ：**設定保持（SD カード等）**、前回設定の保持。
* 防水：**防滴程度（完全防水不要）**、腰装着を前提。
* **コネクタ**：筐体薄型化のため、**出力側コネクタ（PJ1‑023）も Type‑C に変更**。
* **無線／MCU**：EYSHCNZXZ（廃番）→ **ESP32‑WROOM‑32E‑N16（当社推奨）**。**代替**：MBN52832 / WSM‑BL241‑ADA‑008（村田製作所）。**最終選定**：顧客。注意：ESP32はファーム全面移植・厚さ3.1mmで薄型化要件とトレードオフ。
* **Type‑C付帯回路**：各コネクタのCC1/CC2に**5.1kΩプルダウン**を追加（入力1＋出力4＝計10個）。

---

## 3. 基板ブロックの「流用」／「アップデート」仕分け

> 判定は minutes_1 に記載された変更点に基づく。ここでは既存資料で確認できるブロック名を列挙し、**変更指定があるもの＝アップデート**、特に変更指定が無いもの＝**流用** とする。

| 区分 | ブロック（既存）       | 代表部品／端子                        | 判定         | 根拠（minutes_1）                      |
| -- | -------------- | ------------------------------ | ---------- | ---------------------------------- |
| 回路 | 電源変換           | TPS630250                      | 流用         | 変更指定なし                             |
| 回路 | 電源管理           | LTC2955                        | 流用         | 変更指定なし                             |
| 回路 | ロードスイッチ        | TPS22919                       | 流用         | 変更指定なし                             |
| 回路 | 無線／MCU         | **ESP32‑WROOM‑32E‑N16（推奨）／MBN52832（代替）** | **アップデート** | EYSHCNZXZ廃番→見積書2案提示。最終選定は顧客       |
| 回路 | 出力 4ch（MOSFET） | FDV305N×4／PJ1‑023／1N4148WX‑TP  | **アップデート** | 4chのうち2chをスピーカー出力に変更可能／ポート共用化・自動認識 |
| 回路 | 入力 USB コネクタ    | CN1（microUSB: 10118194‑0001LF） | **アップデート** | USB Type‑C 対応に変更                   |
| 回路 | デバッグ／DIP       | SWD／DIP                        | 流用         | 変更指定なし                             |
| UI | LED 表示         | 各種 LED                         | **アップデート** | LED によるモード表示（表示仕様の明確化）             |
| UI | ボタン            | 既存：電源／リセット 等                   | **アップデート** | モード／ボリューム／ピッチ 追加、同時押し機能            |
| メカ | 筐体             | 腰装着ケース                         | **アップデート** | 薄型化・丸み・スリム化・装着快適性                  |
| 仕様 | メモリ            | 設定保持用（外部メモリ等）                  | **アップデート** | 「設定保持（SD 等）」明記                     |
| 仕様 | 防水             | 防滴相当                           | 流用         | 「防滴程度（完全防水不要）」で水準維持                |
| 仕様 | コネクタ（出力側）      | PJ1‑023                        | **アップデート** | ユーザー追記（本スレ）：筐体薄型化のため Type‑C へ変更    |

---

## 4. 付録：既存部品の参照（抜粋・識別目的）

* U1: EYSHCNZXZ（Bluetooth モジュール）
* U3: TPS630250（昇降圧 DC/DC）
* U4: LTC2955（プッシュボタン電源制御）
* U5: TPS22919（ロードスイッチ）
* Q1–Q4: FDV305N（N‑ch MOSFET）
* D7–D10: 1N4148WX‑TP（保護ダイオード）
* CN1: 10118194‑0001LF（microUSB）
* CN4–CN7: PJ1‑023（DC ジャック）
* S3: SKSGACE010（リセットスイッチ）

> ※上記は「既存の事実確認」のためのラベルであり、アップデートの要求や方法論を示すものではありません。

---

## 5. ブロック別詳細（現状／アップデート要求／流用可否）

> 出典の略記：
>
> * 〔既存解析〕= circuit_analysis_document / 回路ブロック動作の詳細解説 / Master部品表_20210430
> * 〔minutes〕= minutes_1
>
> ※提案や将来案は記載せず、**現状記述と minutes に記載のアップデート要求のみ**を対比。

### 5.1 電源入力（USB 系）

* **現状（根拠）**：microUSB（CN1: 10118194‑0001LF）で受電。〔既存解析・部品表〕
* **アップデート（根拠）**：**USB Type‑C に変更**（CN1: Neltron 5077CR‑16‑SMC2‑BK‑TR、見積書）。CC1/CC2へ5.1kΩプルダウン×2を追加、ESD保護を推奨。〔minutes／見積書〕
* **流用可否**：**アップデート**（端子種別置換＋CC回路追加）。

### 5.2 電源変換（昇降圧 DC/DC）

* **現状**：TPS630250 により 3.3V 生成。周辺は L/C/抵抗群で構成。〔既存解析・部品表〕
* **アップデート**：minutes に**変更指定なし**。
* **流用可否**：**流用**。

### 5.3 電源制御（プッシュボタン電源／ロードスイッチ）

* **現状**：

  * プッシュボタン電源コントローラ：LTC2955（長押しによる ON/OFF，電源シーケンス）。
  * ロードスイッチ：TPS22919（中間電源 VDD_MID の ON/OFF）。〔既存解析・部品表〕
* **アップデート**：minutes に**変更指定なし**（同時押しは UI ロジック側の要求）。
* **流用可否**：**流用**。

### 5.4 無線／MCU（BLE モジュール）

* **現状**：太陽誘電 EYSHCNZXZ（BLE，MCU 内蔵モジュール）。SWD 端子・DIP 等あり。〔既存解析・部品表〕
* **アップデート**：**EYSHCNZXZ は廃番**。見積書に基づき **ESP32‑WROOM‑32E‑N16 へ置換（当社推奨）**。
  * メリット：コスト安、Wi‑Fi併用可、開発資産豊富。
  * 留意：ファーム全面移植（nRF52832→ESP32）が必要。モジュール厚さ3.1mmは他実装部品（Type‑C等）と同程度で、機構設計次第で薄型要件に整合可能。
  * **代替案**：**MBN52832 / WSM‑BL241‑ADA‑008（村田）**（同一SoCで移植容易、厚さ0.9mmで薄型化適合）。
  * **最終選定は顧客**（機能要件・筐体制約・工期／コスト優先度に応じて決定）。〔見積書〕
* **流用可否**：**アップデート**。

### 5.5 出力チャンネル（アクチュエータ 4ch）

* **現状**：4ch MOSFET 低側スイッチ（FDV305N×4）。保護ダイオード 1N4148WX‑TP。出力コネクタ PJ1‑023。〔既存解析・部品表〕
* **アップデート**：**4ch のうち 2ch をスピーカー出力に変更可能**／**モーターとスピーカーの自動認識**。〔minutes〕
* **流用可否**：**一部アップデート**（2ch は共用化要件あり／残り 2ch は流用）。

#### 5.5.1 モーター仕様（採用品目）

* **機種**：シリンダー型振動モーター「SD‑0820CY」
* **メーカー**：シナノ電子
* **定格電圧**：3.0 V DC
* **使用電圧範囲**：2.5 ～ 3.5 V DC
* **定格電流**：120 mA
* **定格負荷**：100 g
* **回転方向**：時計回り または 反時計回り

#### 5.5.2 スピーカー／アンプ構成（設計指針）

構成方針：受動スピーカー＋5 V単電源・BTL出力のClass‑Dアンプを用い、スピーカー駆動はアンプで実施。既存MOSFETチャネルはアンプの`/EN`（`/SD`）制御に使用する（スピーカーを直接MOSFETで駆動しない）。

* **スピーカー**：8 Ω、0.5 ～ 1 W、φ28 ～ 40 mmの薄型、高能率（≥ 85 dB）推奨
* **アンプ（推奨）**：I²S対応Class‑Dアンプ（例：MAX98357A）
* **アンプ（代替／簡易）**：アナログIN対応Class‑D（例：PAM8302 / PAM8301クラス：数百 mW ～ 1 W）
* **入力方式**
  * 推奨：I²Sデジタル出力 → MAX98357A（ESP32のI²Sを利用、音質・ノイズ耐性に優れる）
  * 代替：PWM → RCローパス（R = 2.2–4.7 kΩ、C = 22–100 nF）→ アナログIN（最短導入・簡易音質）
* **制御方式**：`/EN`（`/SD`）ピンを既存MOSFETチャネルでGNDに引く、またはMCU直制御（MOSFET制御の場合の電流は数 mA 程度で余裕大）
* **電源・ノイズ対策**
  * アンプ直近：0.1 µF + 10 ～ 100 µF（デカップリング）
  * 5 Vライン強化：100 ～ 470 µF（USBの電源インピーダンス低下対策）
  * BTL出力は両端フローティング（片側をGNDに落とさない）
  * EMI対策：必要に応じてスピーカー直列にフェライトビーズや小型LCを追加

#### 5.5.3 モーター／スピーカー自動認識（推奨実装）

目的：同一ポートをモーター／スピーカーで共用し、接続アクセサリに応じて動作モードを自動切替。

方式（推奨）：アクセサリID抵抗方式（Type‑C SBU活用）

* 物理層：出力側Type‑CのSBU1を`ID_ADC`として基板へ引き出す（SBU2は非接続／GNDは共通）。
* アクセサリ側：
  * モーター（SD‑0820CY）：IDピンは開放（抵抗なし）。
  * スピーカー（アンプ基板）：IDピンに10 kΩをGNDへ接続（/ENは別配線で制御）。
* 基板側回路：
  * `ID_ADC`に対し、3.3 Vへ100 kΩプルアップ＋4.7 nF程度でRCローパス（ノイズ除去）。
  * ADC直前に約1 kΩのシリーズ抵抗（ESD/サージの緩和）。
  * SBUラインにESD保護アレイを近接配置。
* しきい値（例）：
  * 開放（モーター）：`V_ID` > 2.5 V → モーターモード。
  * 10 kΩ（スピーカー）：`V_ID` ≈ 0.25–0.4 V → スピーカーモード。
* MCU処理：
  * 接続直後に`ID_ADC`を複数回サンプリング（例：10 ms間隔×4）し平均化。
  * ヒステリシス付きで判定、誤認時は安全側（モーターモード・低出力）でフォールバック。
* フェールセーフ／運用：
  * スピーカーモードでは「MOSFETで負荷直駆動しない」。MOSFETはアンプ`/EN`（`/SD`）制御のみに使用。
  * モーターモードではアンプ電源/`/EN`を無効化（リーク防止）。
* 注意：CCピンは既に5.1 kΩ運用のため流用しない。SBUをID専用に使用。

（補足：SBU未使用コネクタ構成などでIDピンが確保できない場合は、低電流インピーダンス計測方式を代替として検討。ただし実装複雑度と誤判定リスクは増加。）

### 5.6 ユーザーインターフェース（ボタン／LED）

* **現状**：電源ボタン、リセット（S3: SKSGACE010）、DIP、ステータス LED。〔既存解析・部品表〕
* **アップデート**：

  * **追加ボタン**：モード選択（4 モード）、ボリューム調整、ピッチ調整（5 段階）。
  * **同時押し機能**の実装。
  * **LED によるモード表示**の明確化。〔minutes〕
* **流用可否**：**アップデート**（ボタン追加・表示仕様変更）。

### 5.7 設定保持（メモリ）

* **現状**：既存資料に具体記載なし（外部ストレージの明示なし）。〔既存解析〕
* **アップデート**：**設定保持（SD カード等）**，**前回設定の保持**。〔minutes〕
* **流用可否**：**アップデート**（機能追加）。

#### 5.7.1 microSDモジュール（構成）

* **ソケット**：microSD（push‑push推奨、CD/WP端子付き）
* **電源**：3.3 V。ソケット至近に 0.1 µF + 1–10 µF（必要に応じフェライトビーズ）
* **ESD保護**：SD信号・VDD向けのTVSアレイをコネクタ近傍に配置
* **検出信号**：カード検出（CD）、書込禁止（WP）をプルアップしMCUへ接続

#### 5.7.2 回路実装指針

* **インターフェース**
  * SPIモード：CLK/MOSI/MISO/CS（CSは10 kΩプルアップ、各線33–68 Ωシリーズ）
  * SDMMC 4bit：CLK/DAT0–3/CMD（各線47–100 Ωシリーズ、配線は50 MHz想定のルール遵守）
* **レイアウト**：シールドGNDランド、固定用パッド、短配線・等長配慮（SDMMC時）
* **テスト**：要所にテストポイント（少なくともCLK/CS/DAT0）

#### 5.7.3 インターフェース／ピン割当（SPI固定）

> 当面の運用はSPIモードで固定。I²SやType‑C配線との干渉を避けるため、下記を推奨とする（最終はレイアウト都合で調整）。

| 信号 | ESP32（VSPI推奨） | 備考 |
| --- | --- | --- |
| SCLK | GPIO18 | 33–68 Ωシリーズ推奨 |
| MISO | GPIO19 | 33–68 Ωシリーズ推奨 |
| MOSI | GPIO23 | 33–68 Ωシリーズ推奨 |
| CS   | GPIO5  | 10 kΩプルアップ + 33–68 Ωシリーズ |

| 信号 | MBN52832（例） | 備考 |
| --- | --- | --- |
| SCLK | P0.13 | 33–68 Ωシリーズ推奨 |
| MISO | P0.14 | 33–68 Ωシリーズ推奨 |
| MOSI | P0.15 | 33–68 Ωシリーズ推奨 |
| CS   | P0.12 | 10 kΩプルアップ + 33–68 Ωシリーズ |

注意：上記は代表例。既存I/Oとの衝突やI²S（MAX98357A）配線を避ける目的で最終確定する。

### 5.8 端子／コネクタ（信号・電源）

* **現状**：

  * 電源入力：CN1 microUSB、CN4–CN7 DC ジャック（PJ1‑023）。
  * 出力：バイブレータ用コネクタ実装（PJ1‑023）。〔既存解析・部品表〕
* **アップデート**：

  * 電源入力を **USB Type‑C**（CN1: Neltron 5077CR‑16‑SMC2‑BK‑TR）に変更。〔minutes／見積書〕
  * **出力側コネクタ**を **USB Type‑C**（CN4–CN7: 5077CR‑16‑SMC2‑BK‑TR）×4 に変更。〔ユーザー追記／見積書〕
  * 付帯回路：CC1/CC2に**5.1kΩプルダウン**を各コネクタへ実装（入力1×2本＋出力4×2本＝計10個）。ESD保護を推奨。
* **流用可否**：**アップデート**（電源端子＋出力側端子ともに変更／CC回路追加）。

### 5.9 筐体（メカ） 筐体（メカ）

* **現状**：腰装着ケース。外付けモバイルバッテリー運用。〔minutes 現状記述〕
* **アップデート**：**薄型化／丸み付与／スリム化／装着快適性向上**。〔minutes〕
* **流用可否**：**アップデート**（外観・形状）。

### 5.10 防水・環境条件

* **現状**：腰装着前提の**防滴程度**。〔minutes 現状記述〕
* **アップデート**：**完全防水は不要**（水準維持）。〔minutes〕
* **流用可否**：**流用**（水準変更指定なし）。

### 5.11 認証／適合

* **現状**：Bluetooth 機器として動作。〔既存解析の想定・minutes 記載の前提〕
* **アップデート**：**Bluetooth SIG 認証が必要**（量産版）。〔minutes〕
* **流用可否**：**アップデート**（認証対応が必要という要件記載）。

---

## 6. まとめ（ブロック別の最終仕分け一覧）

| ブロック      | 現状（要約）                | アップデート要求（minutes）                        | 判定       |
| --------- | --------------------- | ---------------------------------------- | -------- |
| 電源入力（USB） | microUSB（CN1）         | Type‑C へ変更                               | アップデート   |
| 昇降圧 DC/DC | TPS630250 による 3.3V 生成 | 変更指定なし                                   | 流用       |
| 電源制御      | LTC2955／TPS22919      | 変更指定なし                                   | 流用       |
| 無線／MCU    | **ESP32（推奨）／MBN52832（代替）** | EYSHCNZXZ廃番→2案提示（最終選定は顧客）                 | アップデート   |
| 出力 4ch    | MOSFET×4（FDV305N）     | 2ch を SP 変更可・自動認識                        | 一部アップデート |
| UI（ボタン）   | 既存：電源／リセット／DIP 等      | MODE・VOL・PITCH 追加／同時押し                   | アップデート   |
| 表示（LED）   | 既存 LED                | モード表示の明確化                                | アップデート   |
| メモリ       | 明示なし                  | 設定保持（microSDソケット／ESD／RC・プルアップ／CD・WP） | アップデート   |
| コネクタ群     | microUSB／PJ1-023 等    | **CN1, CN4–CN7 を Type‑C（5077CR‑16‑SMC2‑BK‑TR）へ変更／CC 5.1kΩ追加** | アップデート   |
| 筐体        | 腰装着ケース                | 薄型・丸み・スリム化                               | アップデート   |
| 防水        | 防滴程度                  | 水準維持（完全防水不要）                             | 流用       |
| 認証        | BLE 製品                | Bluetooth SIG 必要                         | アップデート   |

---

## 7. アップデート対象一覧（抜粋）

> セクション6の仕分けを維持しつつ、アップデート対象のみを抜粋。

| ブロック      | 変更内容（要点） | 判定 |
| --------- | ---------------- | ---- |
| 電源入力（USB） | microUSB → Type‑C（CN1: 5077CR‑16‑SMC2‑BK‑TR）、CC 5.1kΩ×2追加、ESD保護推奨 | アップデート |
| 無線／MCU    | EYSHCNZXZ廃番 → ESP32‑WROOM‑32E‑N16（推奨）／MBN52832（代替） | アップデート |
| 出力 4ch    | 4chのうち2chをスピーカー出力に変更可、ポート共用化・自動認識（ID抵抗方式：SBU）、MOSFETはアンプEN/SD制御に使用 | 一部アップデート |
| UI（ボタン）   | MODE／VOL／PITCH追加、同時押し機能 | アップデート |
| 表示（LED）   | LEDによるモード表示の明確化 | アップデート |
| メモリ       | 設定保持（microSD／SPI運用／ESD／RC・プルアップ／CD・WP） | アップデート |
| コネクタ群     | 出力側CN4–CN7をType‑C（5077CR‑16‑SMC2‑BK‑TR）へ、CC 5.1kΩを各コネクタに追加 | アップデート |
| 筐体        | 薄型化／丸み付与／スリム化／装着快適性向上 | アップデート |
| 認証        | Bluetooth SIG 認証対応 | アップデート |
